name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  publish-npm:
    name: Publish npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install
        run: bun install --frozen-lockfile

      - name: Verify tag matches package version
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME#v}"
          version="$(bun -e "console.log(JSON.parse(Bun.file('packages/fpf/package.json').textSync()).version)")"
          if [[ "$tag" != "$version" ]]; then
            echo "Tag version ($tag) does not match packages/fpf/package.json ($version)"
            exit 1
          fi

      - name: Prepare publish dir
        run: bun develop/scripts/prepare_publish_fpf.ts

      - name: Publish
        working-directory: dist/npm/fpf
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_CONFIG_TOKEN }}
        run: bun publish

  smoke-bunx:
    name: Smoke bunx (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: publish-npm
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Wait for npm propagation
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          for i in {1..30}; do
            if bun info "@venikman/fpf@$version" >/dev/null 2>&1; then
              echo "Package @venikman/fpf@$version is visible."
              break
            fi
            echo "Waiting for @venikman/fpf@$version to appear on npm ($i)..."
            sleep 5
          done
          bun info "@venikman/fpf@$version" >/dev/null

      - name: Fresh-dir init + check (bunx)
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          tmpdir="$(mktemp -d)"
          bunx --bun "@venikman/fpf@$version" init --root "$tmpdir" --json > /dev/null
          bunx --bun "@venikman/fpf@$version" check --root "$tmpdir" --json > /dev/null

  build-binaries:
    name: Build binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install
        run: bun install --frozen-lockfile

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/bin

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            bun build --compile --target=bun-linux-x64 packages/fpf/src/entry.ts --outfile dist/bin/fpf-linux-x64
            bun build --compile --target=bun-linux-arm64 packages/fpf/src/entry.ts --outfile dist/bin/fpf-linux-arm64
            ./dist/bin/fpf-linux-x64 --version
            tmpdir="$(mktemp -d)"
            ./dist/bin/fpf-linux-x64 init --root "$tmpdir" --json > /dev/null
            ./dist/bin/fpf-linux-x64 check --root "$tmpdir" --json > /dev/null
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            bun build --compile --target=bun-darwin-x64 packages/fpf/src/entry.ts --outfile dist/bin/fpf-darwin-x64
            bun build --compile --target=bun-darwin-arm64 packages/fpf/src/entry.ts --outfile dist/bin/fpf-darwin-arm64
            if [[ "$(uname -m)" == "arm64" ]]; then
              smoke="./dist/bin/fpf-darwin-arm64"
            else
              smoke="./dist/bin/fpf-darwin-x64"
            fi
            "$smoke" --version
            tmpdir="$(mktemp -d)"
            "$smoke" init --root "$tmpdir" --json > /dev/null
            "$smoke" check --root "$tmpdir" --json > /dev/null
          else
            bun build --compile --target=bun-windows-x64 packages/fpf/src/entry.ts --outfile dist/bin/fpf-windows-x64.exe
            ./dist/bin/fpf-windows-x64.exe --version
            tmpdir="$(mktemp -d)"
            ./dist/bin/fpf-windows-x64.exe init --root "$tmpdir" --json > /dev/null
            ./dist/bin/fpf-windows-x64.exe check --root "$tmpdir" --json > /dev/null
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.os }}
          path: dist/bin/*

  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-npm, smoke-bunx, build-binaries]
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: binaries-*
          merge-multiple: true
          path: dist/release

      - name: SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          cd dist/release
          sha256sum * > SHA256SUMS

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/release/*
